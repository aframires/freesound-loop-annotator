<!DOCTYPE html>
<html>

<head>

    <style>
        .row {
            display: flex;
        }

        .column {
            flex: 50%;
        }
    </style>

    <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
    <script src="https://tonejs.github.io/build/Tone.js"></script>
    <script>
        var metronome = new Tone.Player("../woodblock.wav").toMaster();
        var audio = new Tone.Player("{{audio_file}}").toMaster();
        $(function () {

            var synth = new Tone.PolySynth(6, Tone.Synth, {
                oscillator: {
                    type: "triangle"
                }
            }).toMaster();

            Tone.Transport.bpm.value = $("input[name=bpm]").val();
            Tone.Buffer.onload = function () {
                //this will start the player on every quarter note
                Tone.Transport.setInterval(function (time) {
                    metronome.start(time);
                }, "4n");
                //start the Transport for the events to start
                Tone.Transport.start();
            };


            function get_answers() {
                var answers = {};
                answers.instrumentation = {
                    drums: $("input[name=drums]").is(":checked"),
                    bass: $("input[name=bass]").is(":checked"),
                    chords: $("input[name=chords]").is(":checked"),
                    melody: $("input[name=melody]").is(":checked"),
                    fx: $("input[name=fx]").is(":checked"),
                    vocal: $("input[name=vocal]").is(":checked")
                }
                answers.bpm = $("input[name=bpm]").val()
                answers.signature = String($("input[name=metricUpper]").val()) + "/" + String($("input[name=metricLower]").val())
                answers.key = $('#key').val()
                answers.mode = $('#mode').val()


                answers.genres = []
                $("#genres input:checkbox:checked").each(function () {
                    answers.genres.push($(this).val())
                });

                answers.comments = $("textarea#comments").val()
                answers.discard = $("input[name=discard]").is(":checked")

                return answers
            }

            function send_answers() {
                var answers = get_answers();
                var data = {
                    answers: answers,
                    page: '{{page}}',
                    id: '{{sound_ids}}'
                }
                $.ajax({
                    url: '/',
                    type: 'post',
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function (data) {
                        console.log(data);
                        window.location.replace("/?p={{page+1}}");
                    },
                    data: JSON.stringify(data)
                });
            }

            function startAudioMetronome() {
                submitBPM()
                Tone.Transport.start()
                audio.start()
            }

            function startAudio() {
                audio.restart()
            }

            function stopAudio() {
                audio.stop()
            }

            function startMetronome() {
                submitBPM()
                Tone.Transport.start();
            }
            function stopMetronome() {
                Tone.Transport.stop();
            }
            function submitBPM() {
                Tone.Transport.bpm.value = $("input[name=bpm]").val();
            }

            function startChords() {
                var chords = ["c", "c#", "d", "d#", "e", "f", "f#", "g", "g#", "a", "a#", "b", "c", "c#", "d", "d#", "e", "f", "f#", "g", "g#", "a", "a#", "b"]
                var index = chords.indexOf($('#key').val())
                var chordsToUse = []
                if ($('#mode').val() == "maj") {
                    chordsToUse = [chords[index].toUpperCase() + "4", chords[index + 4].toUpperCase()  + "4", chords[index + 7].toUpperCase() + "4"]
                }

                if ($('#mode').val() == "min") {
                    chordsToUse = [chords[index].toUpperCase()  + "4", chords[index + 3].toUpperCase() + "4", chords[index + 7].toUpperCase() + "4"]
                }

                console.log(chordsToUse)

                synth.triggerAttack(chordsToUse, undefined, 1)
            }

            function stopChords() {
                synth.releaseAll()
            }

            $('#submit-button').click(function () { send_answers(); });
            $('#startAudioMetronome').click(function () { startAudioMetronome(); });
            $('#startAudio').click(function () { startAudio(); });
            $('#stopAudio').click(function () { stopAudio(); });
            $('#startMetronome').click(function () { startMetronome(); });
            $('#stopMetronome').click(function () { stopMetronome(); });
            $('#startChords').click(function () { startChords(); });
            $('#stopChords').click(function () { stopChords(); });

        });
    </script>

</head>


<body>
    <div class="row">
        <div class="column">
            <h1>{{loop_name}}</h1>
            <p><b>Description:</b> {{description}}</p>
            <p><b>Tags:</b> {{tags}}</p>
            <!-- <img stlye="width:90%;" src="{{sound_image}}" alt="{{sound_image}}"> -->
            <iframe style="display:inline-block;" frameborder="0" scrolling="no" width="481" height="86"
                src="https://freesound.org/embed/sound/iframe/{{sound_ids}}/simple/medium/">
            </iframe>
            <br>
            <button id="startAudioMetronome">Play Audio and Metronome</button>
            <br>
            <button id="startAudio">Restart Audio</button>
            <br>
            <button id="stopAudio">Stop Audio and Metronome</button>
            <br>
            <button id="startMetronome">Play Metronome</button>
            <br>
            <button id="stopMetronome">Stop Metronome</button>
            <br>
            <button id="startChords">Play Chords</button>
            <br>
            <button id="stopChords">Stop Chords</button>
            <br>
            <button id="submit-button" style="margin-left:100px; width:150px; height: 100px;">submit</button>
            <br>

        </div>

        <div class="column">
            <!--
            <p>Is the loop harmonic and/or percussive:</p>
            <form>
                <input type="checkbox" name="harmonic" value="harmonic">Harmonic<br>
                <input type="checkbox" name="percussive" value="percussive">Percussive<br>
            </form>

            <p>Does it contain a single or multiple instruments?</p>
            <form>
                <input type="radio" name="instrumentation" value="single"> Single<br>
                <input type="radio" name="instrumentation" value="multiple"> Multiple<br>
            </form>

            <p>Are these instruments present?</p>
            <form>
                {% for instrument in instruments %}
                <input type="checkbox" name="{{instrument}}" value="{{instrument}}"> {{instrument}}<br>
                {% endfor %}

                <p>Any other instruments? (Add the instrument names separated by commas)</p>
                <input type="text" name="other_instruments" size=80>
            </form>

-->

            <p>What elements does the loop conatin?</p>
            <form>
                <input type="checkbox" name="drums" value="drums"> Drums<br>
                <input type="checkbox" name="bass" value="bass"> Bass<br>
                <input type="checkbox" name="chords" value="chords"> Chords<br>
                <input type="checkbox" name="melody" value="melody"> Melody<br>
                <input type="checkbox" name="fx" value="fx"> Sound FX<br>
                <input type="checkbox" name="vocal" value="vocal"> Vocal<br>
            </form>


            <p>What is the BPM?</p>
            <form>
                <input type="text" name="bpm" value="{{guessedBPM}}">
            </form>

            <p>What is the time signature?</p>
            <form>
                <input type="text" name="metricUpper" value="4"> / <input type="text" name="metricLower" value="4">
            </form>

            <p>What is the key?</p>
            <select id="key">
                <option value="none">None</option>
                <option value="c" {% if guessedKey=="C"  %} selected{% endif %}>C</option>
                <option value="c#" {% if guessedKey=="C#" %} selected{% endif %}>C#</option>
                <option value="d" {% if guessedKey=="D"  %} selected{% endif %}>D</option>
                <option value="d#" {% if guessedKey=="D#" %} selected{% endif %}>D#</option>
                <option value="e" {% if guessedKey=="E"  %} selected{% endif %}>E</option>
                <option value="f" {% if guessedKey=="F"  %} selected{% endif %}>F</option>
                <option value="f#" {% if guessedKey=="F#" %} selected{% endif %}>F#</option>
                <option value="g" {% if guessedKey=="G"  %} selected{% endif %}>G</option>
                <option value="g#" {% if guessedKey=="G#" %} selected{% endif %}>G#</option>
                <option value="a" {% if guessedKey=="A"  %} selected{% endif %}>A</option>
                <option value="a#" {% if guessedKey=="A#" %} selected{% endif %}>A#</option>
                <option value="b" {% if guessedKey=="B"  %} selected{% endif %}>B</option>
            </select>
            <select id="mode">
                <option value="maj" {% if guessedMode=="major"%} selected{% endif %}>Major</option>
                <option value="min" {% if guessedMode=="minor"%} selected{% endif %}>Minor</option>
            </select>

            <p>Does it belong to any of this genres?</p>
            <form id="genres">
                {% for genre in genres %}
                <input type="checkbox" id="{{genre}}" value="{{genre}}"> {{genre}}<br>
                {% endfor %}
            </form>


            <p>Any comments?</p>
            <form>
                <textarea name="comments" id="comments" cols="40" rows="5"></textarea>
            </form>

            <p> <input type="checkbox" name="discard" value="discard"> Discard this loop from our dataset? (If it is not
                a loop) <br></p>

        </div>
    </div>
</body>

</html>